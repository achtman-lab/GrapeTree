<!DOCTYPE html>
<html>
<head>
        
        <link rel="stylesheet" href='js/jquery-ui-1.11.4/jquery-ui.min.css'>
         <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style>
                body{
                        width:100%;
                        height:100%;
                }
                
                #graph-div{
                      
                        position: absolute;
                        top:10px;
                        left:170px;
                        
                }
                
                #sidebar {
                        position:absolute;
                        top:10px;
                        width:170px;
                        margin-left:5px;
                }
                .brush .extent {
                                        stroke: #fff;
                                        fill-opacity: .125;
                                shape-rendering: crispEdges;
                                }
                .selected{
                        background-color:blue;
                }
             

                .graph-selection-indicator {
                  position: absolute;
                  background: transparent;
                  border: 1px solid orange;
                }
                 .slider-class{
                        float: left;
                        clear: left;
                        width: 140px;
                        height:5px;
                        margin: 5px;
                }
                .slider-class .ui-slider-handle {		
                        height:12px;
                }
                .mst-menu-title {
                        
                        cursor:pointer;
                        
                }
                .panel-body label{
                        margin-bottom:1px;
                        margin-top:4px;
                
                }
                .zoom-icon{
                        cursor:pointer;
                        font-size:22px;
                
                }
                .upload-download-icon{
                        cursor:pointer;
                        font-size:22px;
                
                }
                .add-data-icon{
                        cursor:pointer;
                        float:right;
                }
                .mst-menu-title span{
                        display:block;
                        float:right;	
                }
                .panel-default{
                        margin-bottom:2px;
                }
                div.tooltip {	
                        position: absolute;			
                        text-align: center;			
                        //width: 60px;					
                        height: 28px;					
                        padding: 2px;				
                        font: 16px sans-serif;		
                        background: lightsteelblue;	
                        border: 0px;		
                        border-radius: 8px;			
                        pointer-events: none;			
                }
           
                 #welcome-div {
                position: fixed;
                 top: 50%;
                left: 50%;
                 transform: translate(-50%, -50%);
                 height:400px;
                 width:600px;
                 #border-style:solid;
        
                }
                        
              
        </style>
        

</head>
<body>
<!--information divs-->
<div id = 'welcome-div'>
<p align='center'><h2>
<b>G</b>rape <b>T</b>ree
</h2>
</p>
To get started Drag and drop files into the browser window
<h4>Trees or Profile Data</h4>
<ul>
<li><b>Phlogenetic trees</b> These can be nexus or nwk format and can have any file extension apart from
.txt,.csv,.profile and .json
</li>
<li>
<b>Profile Files (.profile)</b> These are tab delimited text with columns as alleles and strains as rows (see the examples).
This requires the local server to be running
</li>
<li><b>Custom Format(.json)</b> Files genereated by this program which contain 
the tree data as well as display information and any metadata
</li>
</ul>
<h4>Metadata</h4>
<ul>
<li>
<b>Metadata files(.txt or.csv)</b> The file should have 
one column 'ID' which corresponds to the node identifier in the tree. Multiple records can be linked to the
same node i.e have the same ID but then the file must have a coulmn 'Name' in which every entry is unique
</li>
</ul>
</div>


<div id ='information-div'class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content modal-sm">
      <div id ="modal-header" class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <p align='center'><img id ='waiting-image'style = 'display:none' src= 'js/img/ms_failed_1.png'></img></p>
	<span id = 'modal-title'></span>
      </div>
      <div class="modal-body">
        <p id ='waiting-information'></p>
	<div  id ='param-panel' style = 'display:none'>	
		   <label>Method</label>
		   <div id='method-activate'></div>
		   <br>
		   <select id ='method-select'>
			   <option value='BASA'>BASA</option>
			   <option value='MST'>MST</option>
			   <option value='NJ'>NJ</option>
		   </select>
		   <div id = "MST-option" style="display:none;">
		   <hr>
		   <label>Matrix Type</label>
		   <br>
		   <select id ='matrix-select'>
			   <option value='symmetric'>Symmetric</option>
			   <option value='asymmetric'>Asymmetric</option>
		   </select>
		   <div id = "symmetric-option">
		   <hr>
		   <label>Missing data</label>
		   <br>
		   <select id = 'missing-data'>
			   <option value='pair_delete'>ignore</option>
			   <option value='complete_delete'>ignore whole loci</option>
			   <option value='as_allele'>treated as an allele</option>
		   </select>
		   <hr>
		   </div>
		   <label>Edge Wieight</label>
		   <br>
		   <select id = 'edge-weight-select'>
			   <option value='eBurst'>eBurst</option>
			   <option value='harmonic'>Harmonic</option>
		   </select>
		   <br>
		   <label>Neighbor Branch Reconnection</label>
		   <br>
		   <select id = 'branch-select'>
			   <option value='F'>False</option>
			   <option value='T'>True</option>
		   </select>
		   </div>
		   
		   
		  
				       
	   </div>
      </div>
      <div class="modal-footer">
        <button id ="modal-ok-button" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<div id='sidebar'>
<p>
<a href="https://enterobase.warwick.ac.uk"><img src="js/img/enterobase.png" alt="Enterobase" style="width:40px;height:45px;"></a>    |    
<a href="https://github.com/martinSergeant/EnteroMSTree"><img src="js/img/GrapeTree.PNG" alt="GrapeTree" style="width:40px;height:50px;"></a>
<h3 id="headertag" style="font-family: times, serif; font-size:12pt; font-style:italic">GrapeTree</h3>
</p>
<br>
        <label>Colour By:</label>
        <br>
        <select style="width:140px" id= 'metadata-select'></select>
        
        <p align = 'center'>
        <span onclick= "javascript:the_tree.setScale(1.1,true)" class=' zoom-icon glyphicon glyphicon-zoom-in'></span>
        <span onclick= "javascript:the_tree.setScale(0.9,true)"class='zoom-icon glyphicon glyphicon-zoom-out'></span>
        </p>
        
     <div class='panel panel-default'  style ="margin-bottom:2px">	
               <div class ='panel-heading mst-menu-title' id= 'mst-link-menu'> <b id>Links</b><span id = 'mst-link-menu-icon' class='glyphicon glyphicon-menu-right'> </span></div>
               <div class = "panel-body" id ='mst-link-menu-panel'>	
                       <label>Link Length</label>
                       <br>
                       <div title = "500" id = "slider-linklength" class ="slider-class">  </div>
                       <br>
                        <label><input id ='link-log-scale'type="checkbox"  />Log Scale</label>
                        <br>
                        <label>Hide Links Over:</label>
                        <br>
                        <input type='text' style='width:35px;height:15px' id ='spinner-hide-link-length'>
                       <button id ='button-hide-link-length'>Go</button>
                       <br>
                       <label>Max Link Length:</label>
                       <br>
                       <input type='text' style='width:35px;height:15px' id ='spinner-maxlinklength'>
                       <button id ='button-setmaxlinklength'>Go</button>
                       <br>
                       <label><input id ='show-link-labels'type="checkbox" /> Link Labels</label>
                       <br>
                       <label>Font Size</label>
                       <br>
                       <div title = "14" id = "slider-linkfontsize" class = "slider-class"></div>
                       <br>
                       <label><input id ='show-link-tooltip' type="checkbox" checked /> Show Tooltip</label>
               </div>
       </div>
       <div class='panel panel-default'>	
               <div class ='panel-heading mst-menu-title' id= 'mst-node-menu'> <b id>Nodes</b><span id = 'mst-node-menu-icon' class="glyphicon glyphicon-menu-right"></span></div>
               <div class = "panel-body" id ='mst-node-menu-panel'>		
                        <label>Node Size</label>
                        <br>
                        <div title = "10" id = "slider-nodesize" class = "slider-class"></div>
                        <br>
                        <label>Relative Size</label>
                        <br>
                        <div title = "1" id = "slider-relative-nodesize" class = "slider-class"></div>
                        <br>
                        <label><input id ='show-node-labels'type="checkbox" checked /> Node Labels</label>
                        <br>
                        
                        <label>Font Size</label>
                        <br>
                        <div title = "12" id = "slider-node-fontsize" class = "slider-class"></div>
                        <label>Label Text</label>
                        <select id = 'node-label-text'><option value="">ID</option></select>
               			<label>Search in Label</label>
						<br>
						<input size="11" id ='search-metadata-input'><span id ='search-metadata-icon' class='add-data-icon glyphicon glyphicon-search'></span>

                        <br>
                        <label><input id ='show-node-tooltip' type="checkbox" checked /> Show Tooltip</label>
                        <br>
                        <label><input id ='show-individual-segments' type="checkbox" /> Show All Segments</label>
                </div>
        </div>
        <div class='panel panel-default'>	
                <div class ='panel-heading mst-menu-title' id= 'mst-layout-menu'> <b id>Layout</b><span id = 'mst-layout-menu-icon' class="glyphicon glyphicon-menu-right"></span></div>
                <div class = "panel-body" id ='mst-layout-menu-panel'>
                          <label>Collapse Nodes::</label>
                        <br>
                        <input type='text' style='width:80px;height:20px' id ='spinner-collapse-nodes'>
                       <button id ='button-collapse-nodes'>Go</button>
                       <br>
                       
                        <div id = "slider-collapse-nodes" class = "slider-class"></div>
                       
                       <br>
			<hr>
                        <p align='center'>
                                <button onclick ="javascript:the_tree.unfixSelectedNodes()"> Unfix Selected</button>
                        </p>
                        <p align='center'>
                                <button onclick = 'javascript:the_tree.unfixSelectedNodes(true)' > Unfix All</button>
                        </p>
                        <p align='center'>
                                <button onclick = 'the_tree.fixAllNodes()' > Fix All</button>
                        </p>
                        <p align='center'>
                                <button onclick = 'the_tree.resetLinkLengths()' > Correct Links</button>
                        </p>	
                        <label>Charge</label>
                        <br>
                        <div title = "0" id = "slider-charge" class = "slider-class"></div>
                        <br>

		   <label>Initial Layout Algorithm</label>
		   <br>
		   <select id = 'layout-select'>
			   <option value='greedy'>Greedy</option>
			   <option value='force'>Force</option>
		   </select>
                </div>
        </div>
   
	<div id = 'add-data-panel' class='panel panel-default'>	
                <div class ='panel-heading mst-menu-title' id= 'mst-data-menu'> <b id>Metadata</b><span id = 'mst-data-menu-icon' class="glyphicon glyphicon-menu-right"></span></div>
                <div class = "panel-body" id ='mst-data-menu-panel'>	
                        <label>Add Field&nbsp;&nbsp;&nbsp;</label>
                        <input  size="11" id ="add-extra-field-input">
                        <span  id ="add-custom-field-icon" onclick="addExtraField()" class='add-data-icon glyphicon glyphicon-plus'></span>
                        <br>
                        
                        <label>Edit Metadata</label>
			<br>
                        Field<select style ="width:120px" id="add-new-values-select"></select><span    onclick="deleteMetadataCategory()" class='add-data-icon glyphicon glyphicon-remove'></span>
                        Add Value To Selected<input size="11" id ="add-new-values-input">
                        <span  id ="add-new-values-icon"  onclick="addNewValues()" class='add-data-icon glyphicon glyphicon-plus'></span>
                        <br>
                                          
                </div>
        </div>

	

 
	<br>
	<p align='center'>
		<button id = 'button-refresh'> Refresh</button>
	</p>
         <p align = 'center'>
                <button id ="center-graph-button">Centre Tree</button>
        </p> 
	<hr>

        <p align='center'>
				<button id = 'button-load-nwk'> Load Tree/Profile</button>
        </p>
	    <p align='center'>
				<button id = 'button-load-meta'> Load Metadata</button>
		</p>
		<hr>
	<p align = 'center'>
		<button id ="save-tree-json">Save Tree</button>
	</p>
	<p align = 'center'>
		<button id ="mst-download-svg">Download SVG</button>
	</p>
</div>

<div id = "graph-div" class="graph-overlay"></div>

<script src="js/main/jquery-1.9.1.min.js"></script>
<script src ="js/jquery-ui-1.11.4/jquery-ui.min.js"></script>
<script src ="js/main/bootstrap.min.js"></script>
<script charset="utf-8" src="js/main/d3.min.js"></script>
<script charset="utf-8" src="js/main/spin.min.js"></script>
<script charset="utf-8" src="js/tree/base_tree.js"></script>
<script charset="utf-8" src="js/tree/d3_m_tree.js"></script>

<script>
        MSFileChooser.prototype = Object.create(null);
        MSFileChooser.prototype.constructor= MSFileChooser;
        
        function MSFileChooser(filter){
                var self = this;
                this.fileInput = $("<input>").attr("type","file").css("display","none");
                this.callback=null;
                this.fileInput.attr("accept",filter);
                $('<body>').append(this.fileInput);         
                this.fileInput.change(function(event){  
                        self.callback(event.target.files);

                });
        
        }
        MSFileChooser.prototype.setFilter=function(filter){
                this.fileInput.attr("accept",filter);
        }
        MSFileChooser.prototype.showOpenDialog=function(callback){
                this.callback=callback;
                this.fileInput.trigger("click");
        }
        
       
        function MSCSCReader(file,delimiter,callback){
                var reader = new FileReader();
                reader.onload = function(progressEvent){
                        var return_data=[];
                        try{
                                var data =this.result;
                                var lines =  data.split(/\r\n|\r|\n/g);
                                var header = lines[0].split(delimiter);
                                var header_index={}
                                for (var i=0;i<header.length;i++){
                                        header_index[i]=header[i];
                                
                                }
                                
                                for (var i=1;i<lines.length;i++){
                                        var map = {};
                                         var arr = lines[i].split(delimiter);
                                         for (var col in arr){
                                                map[header_index[col]]=arr[col];                          
                                         }
                                         return_data.push(map);
                                }
                               
                        }catch(error){
                                callback("Error",error.message)
                                
                        }
                        callback("OK",return_data,header_index);
                };
                reader.readAsText(file);
        };
        
        function saveTextAsFile (text,suggested_name){
        
                var save = $("<a download><button>Save</button></a>").click(function(){
                        var name=$("#filename").val();
                        if(!name){
                            return;
                        }          
                        //windows - don't actually use the file download anchor
                        if(window.navigator.msSaveOrOpenBlob) {
                            var data = new Blob([text], {type: 'text/plain'});   
                            window.navigator.msSaveBlob(data,name);
                        }
                        //others
                        else{
                            var data = new Blob([text], {type: 'text/plain'});
                           
                            this.textFile = window.URL.createObjectURL(data);
                            //set file name and contents before click event propogates
                            $(this).attr("download",name);
                            $(this).attr("href",this.textFile);
                
                        }
                        $(".ui-dialog-content").dialog().dialog("close");
            
                });       
                //the actual dailog box    
                $("<div id ='savedailog'></div>")
                .html("File Name: <input type='text' id ='filename' value='"+suggested_name+"'>")
                .dialog({
                    autoOpen: true,
                    modal: true,
                    title: "Save File",
                    buttons: {
                        "Cancel": function () {
                           
                            $(this).dialog("close");
                        }
                    },
                    close: function () {
                        $(this).dialog('destroy').remove();
                    }
                }).append(save);
        };
	
	function getSuffix(name){
		var arr = name.split(".");
		return arr[arr.length-1];
	}
        
        var all_files=null;
	var metatdata_file_name;
        var waiting_spinner= null; 
        var collapse_scale=1;
        var waitingDialog = null;
        var the_tree = null;
        var tree_name="";
	var cannot_connect=false;
	
	var default_control_panel_values={
		max_link_scale:500,
		base_node_size:10,
		max_link_length:"",
		size_power:0.5,
		log_link_scale:false,
		show_individual_segments:false,
		link_font_size:14,
		show_link_labels:false,
		show_node_labels:true,
		node_font_size:12,
		hide_link_length:"",
		node_collapsed_value:0	
	};
	
		
		
		
		
        var tooltip_div =d3.select("body")
                                        .append("div")	
                                        .attr("class", "tooltip")				
                                        .style("opacity", 0);
        var legend_colour_chooser = $("<input>")
                                        .on("change",function(e){
                                                var cc  = $(this);
                                                the_tree.setColour(cc.data("category"),cc.data("value"),cc.val());
                                                the_tree.changeCategory(cc.data("category"));
                                                
                                        })                                  
                                        .attr("type","color").hide();
        
        $("body").append(legend_colour_chooser);
        
        //a map of group to another map of name to label
        var metadata_options={};
        var new_metadata_fields=[];
	
        var locus_label ="";
        var file_chooser = new MSFileChooser(".nwk");
        var current_metadata_file = null;
	var all_files=null;
	var metadata_file_name = null;
        
        
                
        function downloadMetadata(){
                var lines= [];
                lines.push("Barcode\tName");
                for (var id in the_tree.metadata){
                        var item = the_tree.metadata[id];
                        var barcode = Enterobase.encodeBarcode(id,db_code);
                        lines.push(barcode+"\t"+item["Name"]);
                        
                }
                var text= lines.join("\n");
                Enterobase.showSaveDialog(text,"tree.json");
        }
        
      
        
      
        
        function addMetadataOptions(value,label){
                if (!metadata_options[value]){
                        metadata_options[value]=label;
                        $("#metadata-select").append($("<option>").attr("value",value).text(label));
                        $("#node-label-text").append($("<option>").attr("value",value).text(label));
                        $("#add-new-values-select").append($("<option>").attr("value",value).text(label));
                
                }
        }
	function deleteMetadataCategory(){
		var category = $("#add-new-values-select").val();
		the_tree.removeCategory(category);
		$("#metadata-select option[value='"+category+"']").remove();
		$("#node-label-text option[value='"+category+"']").remove();
		$("#add-new-values-select option[value='"+category+"']").remove();
		delete metadata_options[category];
	}
        
        
        function showToolTip(msg){
                        tooltip_div.transition()		
                        .duration(200)		
                        .style("opacity", .9);		
                        tooltip_div.html(msg)	
                        .style("left", (d3.event.pageX) + "px")		
                        .style("top", (d3.event.pageY - 28) + "px");
        }
        
        function hideToolTip(){
                        tooltip_div.transition()		
                        .duration(500)		
                        .style("opacity", 0);	
        }
        
        
        
        
        
        function addNewValues(){
                var value = $("#add-new-values-input").val();
                if (! value){
                        return;
                }
                var ids = the_tree.getSelectedIDs();
                var len = ids.length;
                if (len ===0){      
                        return;
                
                }  
                var field = $("#add-new-values-select").val();
	
                var meta = {};
                for (var i in ids){
                        var id = ids[i];
                        var obj={}
                        obj[field]=value;
                        meta[id]=obj;
                
                }
                the_tree.addMetadata(meta);
                the_tree.changeCategory(field);
		the_tree.clearSelection();
        }	
        
        
        function addExtraField(){
                var name = $("#add-extra-field-input").val();
                if (!name){
                        return;
                }
                addMetadataOptions(name,name);
                $("#metadata-select").val(name);
                $("#add-new-values-select").val(name);
                the_tree.changeCategory(name);
              
        }
        
        function treeLoaded(tree){
                
                tree.legendItemClicked = function(data){    
                        legend_colour_chooser
                        .css({"left":0,"top":0})
                        .val(data.colour)
                        .data({"value":data.value,"category":data.category})
                        .trigger("click");         
                };
             
                
                var min = tree.min_link_distance;
                if (min<1){
                        collapse_scale = 1/min;
                }
                var max = (tree.max_link_distance)*collapse_scale;
                var step = max/100;
                $( "#slider-collapse-nodes" ).slider({
                        min:0,
                        max: max,
                        value: tree.node_collapsed_value*collapse_scale,
                        step:step
              });
	      
          
                        tree.centerGraph();
                for (var index in all_files){
			if (all_files[index].name === metadata_file_name){
				loadMetadataFile(all_files[index],current_metadata_file[1]);
				break;
			}
                }
		$(waiting_spinner.el).hide();
                 $("#waiting-information").text("Complete. Tree has "+tree.force_nodes.length+" nodes");
                 $("#waiting-image").attr("src","js/img/ms_complete_1.png").show();
               // legend_colour_chooser.hide();
		$("#information-div").modal("hide");
                
        }
        
        function treeLoading(tree,msg){
                if (msg==='complete'){
                        treeLoaded(tree);
                }
                else{
                        
                        $("#waiting-information").text(msg)
                
                }
        
        }
        
        
        function loadTreeFile(file){
              initiateLoading("Processing "+file.name)
              //give time to dialog to display
              setTimeout(function(){
                        readFile(file,function(tree){
                                 var data={};
				 var suffix = getSuffix(file.name);
                                 if (suffix === 'json'){
                                     data =JSON.parse(tree);      
                                 } 
                                 else if (tree.substring(0,6)==="#NEXUS"){
                                         data['nexus']=tree;
					 data['layout_algorithm']=$("#layout-select").val();
                                 }
                                 else{
                                         data['nwk']=tree;
					 data['layout_algorithm']=$("#layout-select").val();
                                 }
                                 loadMSTree(data)                
                        });
                },500);
        }
        
        function readFile(file,callback){
                var reader = new FileReader();
                reader.onload = function(progressEvent){                    
                        callback(this.result);
                }
                reader.readAsText(file); 
        }
        
        
       
        
        function loadFailed(msg){
		$("#information-div").modal("show");
		$(waiting_spinner.el).hide();
                $("#waiting-image").attr("src","js/img/ms_failed_1.png").show();
                $("#waiting-information").text(msg);
        }
	
	function setControlPanel(data){
		   
		$("#slider-linklength").slider("value",data['max_link_scale']);
		$("#slider-nodesize").slider("value",data['base_node_size']);
		if (data['max_link_length']){
			$("#spinner-maxlinklength").val(data['max_link_length']);			
		}
		if (data['size_power']){
			$("#slider-relative-nodesize").slider("value",data['size_power']);			
		}
		if (data['log_link_scale']){
			$('#link-log-scale').prop('checked', true);
		}
		if (data['show_individual_segments']){
			$("#show-individual-segments").prop("checked",true);
		}
		if (data['link_font_size']){
			$("#slider-link-fontsize").slider("value",data['link_font_size']);
		}
		var sll =true;
		if (data['show_link_labels']===false){
			sll= false;
		}
		
		$("#show-link-labels").prop("checked",sll);
		$("#show-node-labels").prop("checked",data['show_node_labels']);
		if (data['node_font_size']){
			$("#slider-node-fontsize").slider("value",data['node_font_size']);			
		}
		if (data['hide_link_length']){
			$("#spinner-hide-link-length").val(data['hide-link-length']);			
		}
		$( "#slider-collapse-nodes" ).slider("value",data["node_collapsed_value"]);
		$("#spinner-collapse-nodes").val(data["node_collapsed_value"])
				
	
	}
         
   
        
        function loadMSTree(data){
              
                $("#waiting-information").text("Loading Data");
                the_tree = null;
               
                try{
                        the_tree = new D3MSTree(
                        "graph-div",data,function(tree,msg){
                                treeLoading(tree,msg);
                        
                        });
                      
                        the_tree.addSegmentOverListener(function(d){
                                if ($("#show-node-tooltip").prop("checked")){
                                        var display = d.data.type;
                                        if (d.data.node_id){
                                                display = d.data.node_id;
                                        }
                                        showToolTip(display+"("+d.data.value+")");
                                }
                        });
                        the_tree.addSegmentOutListener(function(d){
                                 hideToolTip();	
                        });
                        the_tree.addLinkOverListener(function(d){
                                if ($("#show-link-tooltip").prop("checked")){
                                        showToolTip("length:"+d.value);
                                }
                        
                        });
                        the_tree.addLinkOutListener(function(d){
                                hideToolTip();	
                        });
                        the_tree.resize();
			if (data['metadata_options']){
                              
                                for (var key in data['metadata_options']){
                                       addMetadataOptions(key,data['metadata_options'][key]);      
                                }
                        }
			if (data['initial_category']){
				$("#metadata-select").val(data['initial_category']);
			}
			if (data['layout_data'] && data['layout_data']['nodes_links']){
				setControlPanel(data['layout_data']['nodes_links'])
			}
			else{
			
				setControlPanel(default_control_panel_values);
			}
                }catch(e){
                       console.log(e.message);
		       console.log(e.stacktrace);
                       loadFailed("The file could not be read. Plase check the format");
                
                }
	}
                

 function filesDropped(files){
	all_files=files;
	metatdata_file_name="";
	current_metadata_file=null
	var tree_file=null, profile_file =null;
	for (var i=0;i<files.length;i++){
		var file = files[i];
		var first_blob = file.slice(0, 2048);
		var reader = new FileReader();
		reader.onload = function(progressEvent){
			var head_line = this.result.split(/[\n\r]/)[0];
			if (head_line.indexOf("ID") >= 0) {
				var dl = (head_line.indexOf(",") >= 0 ? "," : "\t");
				current_metadata_file=[this.file, dl];
				metadata_file_name = this.file.name;
				if (the_tree) loadMetadataFile(current_metadata_file[0], current_metadata_file[1]);
			}
			else if (head_line.indexOf("\t") >= 0 || head_line.indexOf(">") >= 0 || (head_line.indexOf("#") == 0 && head_line.indexOf("#NEXUS") < 0 && head_line.indexOf("#nexus") < 0 )) {
				if (cannot_connect){
					loadFailed("Cannot Connect to the backend server");
					return;
				}
				profile_file=this.file;
				 initiateLoading("Reading Profile File");
				$("#param-panel").show();
				$("#modal-ok-button").data("profile_file",profile_file);
				$("#modal-ok-button").html("OK");
				$(waiting_spinner.el).hide();
				$("#modal-title").show().text("Parameters For Tree Creation");
				$("#waiting-information").hide();
				document.getElementById("headertag").innerHTML = this.file.name;
			}
			else {
				tree_file = this.file;
				loadTreeFile(tree_file);
				document.getElementById("headertag").innerHTML = this.file.name;
			}
		};
		reader.file = file;
		reader.readAsText(first_blob);
	}
 }
 
 function initiateLoading(msg){
	$("#welcome-div").hide();
	$("#graph-div").empty();
	$("#metadata-select").empty();
	$("#node-label-text").empty().append($("<option>").val("").text("default"));
	$("#add-new-values-select").empty();
	metadata_options={};
	showWaitingDialog(msg);
 
 }
 
function showModalForParams(){
	$("#information-div").modal("show");
	$("#param-panel").show();
	

} 
 
 
 function processProfileFile(profile_file){
	
      
        readFile(profile_file,function(profile){
              try{
                $.ajax({
                        method: "POST",
                        url: "/maketree",
                        data: {
				profile:profile,
				method:$("#method-select").val(),
				matrix_type:$("#matrix-select").val(),
				edge_weight:$("#edge-weight-select").val(),
				neighbor_branch_reconnection:$("#branch-select").val(),
				missing_data:$("#missing-data").val()
				}
                }).done(function(result){
                       loadMSTree({"nwk":result,"layout_algorithm":$("#layout-select").val()});          
               }).fail(function( jqXHR, textStatus){
						if (jqXHR.status == 405 || jqXHR.status == 404) {
							loadFailed("Cannot reach the backend. Please download a FREE standalone version from https://github.com/martinSergeant/EnteroMSTree/");
						} else {
							console.log(textStatus);
							loadFailed("There server returned an error. Is the profile file in the right format");
						}
               });
               }catch(e){
                        loadFailed("The server could not be contacted");
               }
                $("#waiting-information").text("Computing Tree");
        });
 };
 
 function showWaitingDialog(msg){
	$("#information-div").modal("show");
	$("#waiting-image").hide();
	$(waiting_spinner.el).show();
	$("#waiting-information").text(msg).show();
 }
 
 
 
 
 
 function loadMetadataFile(file, dl){
        MSCSCReader(file,dl,function(msg,lines,header_index){
                var meta={};
		
                for (var i in lines){
                        var line = lines[i];
			if (line['Name']){
				meta[line['Name']]=line;
			}
			else if (line['ID']){
				meta[line['ID']]=line;
			}
                }
                the_tree.addMetadata(meta);
                var category = null;
                for (var i in header_index){
                        var header = header_index[i];
                        if (header !== 'ID'){
                                addMetadataOptions(header,header);
                                if (!category){
                                        category=header;
                                }
                        }
                }
                $("metadata-select").val(category);
                the_tree.changeCategory(category);
        });
 };



window.onload = function (){
        //allow dragging and dropping files
        $("#graph-div").on('dragover',function(e) {
                e.preventDefault();
                e.stopPropagation();
            }
        )
        .on('dragenter',function(e) {
                e.preventDefault();
                e.stopPropagation();
                }
        )
        .on("drop",function(e){
                e.originalEvent.stopPropagation();
                e.originalEvent.preventDefault();
                var files = e.originalEvent.dataTransfer.files;
                filesDropped(files);             
        });
        
                
       
        
        $("#upload-metadata-icon").click(function(e){
                if (!metadata_options['Custom Fields']){
                        Enterobase.modalAlert("Please add a custom field before uplaoding a file containing values for this field");
                        return;      
                }
                var i = Enterobase.makeCustomFileInput("fileupload",function(file){  
                        uploadMetadata(file);
                });
                i.trigger("click");
        });
 
        $("#metadata-select").on("change",function(e){
                the_tree.changeCategory($(this).val());
        });
        $("#node-label-text").change(function(e){
               the_tree.setNodeText($(this).val());
        });
        
        $(window).resize(function(){
                var winh = ($(window).height())-15;
                var winw = ($(window).width());
                var div  = $("#graph-div");
                var sb_width = $("#sidebar").width();
                div.height(winh).css({"max-height":winh+"px","min-height":winh+"px"});
                $("#graph-div").width(winw-sb_width);
        });
        $(window).trigger("resize");
        
       
        $("#mst-download-svg").click(function(e){
                the_tree.downloadSVG(tree_name);
        });
        
        
        $(".mst-menu-title").click(function(e){
                var id = $(this).attr("id");
                var this_panel =  $("#"+id+"-panel");
                var icon = $("#"+id+"-icon");
                if  (this_panel.hasClass("open-menu-panel")){
                        this_panel.toggle("50");
                        this_panel.removeClass("open-menu-panel");
                        icon.attr("class","glyphicon glyphicon-menu-right"); 
                }
                else{
                        $("#"+id+"-panel").toggle("50");
                        icon.attr("class","glyphicon glyphicon-menu-down"); 
                        $(".open-menu-panel").toggle("50");
                        $(".open-menu-panel").parent().find(".glyphicon-menu-down").attr("class","glyphicon glyphicon-menu-right"); 
                        $(".open-menu-panel").removeClass("open-menu-panel");
                        $("#"+id+"-panel").addClass("open-menu-panel");
                }
                
        });
        $(".panel-body").hide();
        
        $( "#slider-linklength" ).slider({
                orientation: "horizontal",
                min:50,
                max: 50000,
                value: 500,
                slide:function(){the_tree.setLinkLength($("#slider-linklength").slider("value"));
										$(this).attr("title", $(this).slider("value"));
				},
                change: function(e){
                        if (e.originalEvent){
                                the_tree.setLinkLength($("#slider-linklength").slider("value"));
                        }
                }
        });

        $( "#slider-nodesize" ).slider({
                orientation: "horizontal",
                min:2,
                max:50,
                value: 10,
                slide:function(){the_tree.setNodeSize($("#slider-nodesize").slider("value"));
										$(this).attr("title", $(this).slider("value"));},
                change: function(e){
                        if (e.originalEvent){
                                the_tree.setNodeSize($("#slider-nodesize").slider("value"));
                        }
                }
        });
        $( "#slider-relative-nodesize" ).slider({
                orientation: "horizontal",
                min:0.2,
                max:0.8,
                value: 0.5,
                step:0.02,
                slide:function(){the_tree.setRelativeNodeSize($("#slider-relative-nodesize").slider("value"));
										$(this).attr("title", $(this).slider("value")*2);},
                change: function(e){
                        if (e.originalEvent){
                                the_tree.setRelativeNodeSize($("#slider-relative-nodesize").slider("value"));
                        }
                }
        });
        $( "#slider-node-fontsize" ).slider({
                orientation: "horizontal",
                min:6,
                max: 30,
                value: 12,
                slide:function(){the_tree.setNodeFontSize($("#slider-node-fontsize").slider("value"));
									$(this).prop("title", $(this).slider("value"));},
                change: function(e){
                        if (e.originalEvent){
                                the_tree.setNodeFontSize($("#slider-node-fontsize").slider("value"));
                        }
                }
        });
        $( "#slider-linkfontsize" ).slider({
                orientation: "horizontal",
                min:6,
                max: 30,
                value: 14,
                slide:function(){the_tree.setLinkFontSize($("#slider-linkfontsize").slider("value"));
									$(this).prop("title", $(this).slider("value"));},
                change: function(e){
                        if (e.originalEvent){
                                the_tree.setLinkFontSize(($("#slider-linkfontsize").slider("value")));
                        }
                }
        });
        
        $( "#slider-charge" ).slider({
                orientation: "horizontal",
                min:0,
                max: 30,
                slide:function(){the_tree.alterCharge($("#slider-charge").slider("value"));
									$(this).prop("title", $(this).slider("value"));},
                change: function(){the_tree.alterCharge($("#slider-charge ").slider("value"));
									$(this).prop("title", $(this).slider("value"));}
        });

        $("#node-label-text").change(function(e){
                var val = $(this).val();
                if (val ==="cat"){
                        val = the_tree.display_category;
                }
                the_tree.setNodeText(val);
        });

        
        $("#spinner-maxlinklength").spinner({
                min:100,
                step:100
        })
        
        $("#spinner-hide-link-length").spinner({
                min:1,
                step:10000
        });
        $("#button-setmaxlinklength").click(function(){
                var max  = $("#spinner-maxlinklength").val();
                if (max){
                        the_tree.setMaxLinkLength(max);
                }	
        });
        $("#button-hide-link-length").click(function(){
                var max  = $("#spinner-hide-link-length").val();
                if (max){
                        the_tree.setHideLinkLength(max);
                }	
        });
        $("#button-refresh").click(function(){
		showWaitingDialog("Refreshing The Tree");
		setTimeout(function(){
			the_tree.refreshGraph();
			$("#information-div").modal("hide");
		},500)
                
        });
        $("#show-link-labels").click(function(e){			
                the_tree.showLinkLabels($(this).is(":checked"))	
        });
        $("#show-node-labels").click(function(e){
                the_tree.showNodeLabels($(this).is(":checked"));
        });
        $("#show-individual-segments").click(function(e){
                the_tree.showIndividualSegments($(this).is(":checked"));
        });
                
        $("#show-node-tooltip").click(function(e){
                show_node_tooltips = $(this).is(":checked");
        });
                
        $("#link-log-scale").click(function(e){
                the_tree.setLogLinkScale($(this).is(":checked"));
        });
        
        $("#button-load-nwk").click(function(e){
                file_chooser.setFilter("");
                file_chooser.showOpenDialog(function(files){
                        filesDropped(files);
                
                });
        });
        
          $("#button-load-meta").click(function(e){
                file_chooser.setFilter(".txt,.csv");
                file_chooser.showOpenDialog(function(files){
                        filesDropped(files);
                });
        });
        
      
        
        
         $( "#slider-collapse-nodes" ).slider({
                orientation: "horizontal",
                min:0,
                max: 100,
                value: 0,
                slide:function(){
                        var val = $("#slider-collapse-nodes").slider("value")/collapse_scale;
                                $("#spinner-collapse-nodes").val(val);
                        },
                change: function(e){
                        if (e.originalEvent){
                               var val = $("#slider-collapse-nodes").slider("value")/collapse_scale;
                                the_tree.collapseNodes(val);
                               $("#spinner-collapse-nodes").val(val);
                        }
                }
        });
        
        $("#button-collapse-nodes").click(function(e){
			the_tree.collapseNodes($("#spinner-collapse-nodes").val());
        });
        
        $("#save-tree-json").click(function(e){
                var obj= the_tree.getTreeAsObject();
                obj['metadata_options']=metadata_options;
                saveTextAsFile(JSON.stringify(obj),"ms_tree.json");
        
        });
        
        $("#center-graph-button").click(function(e){
             the_tree.centerGraph();
        
        });
	
	$("#search-metadata-icon").click(function(e){
		var keyword= $("#search-metadata-input").val();
		if (!keyword){
			return;
		}
		var ids = the_tree.searchMetadata(keyword, $("#node-label-text").val());
		the_tree.highlightNodes(ids);
	});
	
	$("#modal-ok-button").click(function(e){
		var profile_file =  $(this).data("profile_file")
		if (profile_file){
			processProfileFile(profile_file);
			$(this).data("profile_file",null);
			$("#modal-oj-button").html("Close");
			$("#param-panel").hide();
			e.stopImmediatePropagation();
			$("#modal-title").hide();
			showWaitingDialog("Processing Profiles");
		}
	});
        
        $("#method-select").change(function(e) {
			if ($(this).val() == "MSTree") $("#MST-option").show();
			else $("#MST-option").hide();
		})
        
        $("#matrix-select").change(function(e) {
			if ($(this).val() == "symmetric") $("#symmetric-option").show();
			else $("#symmetric-option").hide();
		})
		
		$("#graph-div").on('dblclick', function(e){
		    if (the_tree) the_tree.clearSelection();
       })
	try_backend();
	var target = document.getElementById('modal-header')
	waiting_spinner= new Spinner({color:'black', lines: 12,top:"13%"}).spin(target);
	
	
	
};

function try_backend(){
  try{
	$.ajax({
			method: "POST",
			url: "/maketree",
	}).done(function(result){})
	.fail(function( jqXHR, textStatus){
		if (jqXHR.status != 406) {
			cannot_connect=true;
		}
    });
   }catch(e){
		cannot_connect=true;
   }
 };
</script>
</body>
</html>
